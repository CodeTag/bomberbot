<!DOCTYPE html>

<html>
<head>
	<title>Bomberbot challenge </title>
	<style>
		body{
			background-color:#000;
		}
	</style>
	<script>
		var tipos= ['c','d','r','t'];
		var colores= ['a','b','f','m','n','r','v'];
		var ctx=undefined;
		var size=50;
		var MOVF=30;
		var turno=0;
		
		var tempVelocidad=MOVF;
		var cambiarVelocidad= function(velocidad){
			tempVelocidad = velocidad;
		}
		
		var crearRandomRobot = function(){
			var tipoSel = Math.round(Math.random()*(tipos.length-1));
			var colorSel = Math.round(Math.random()*(colores.length-1));
			return tipos[tipoSel]+""+colores[colorSel];
		};
		
		var Bot = function(tipoRobot, xIndex, yIndex){
			this.sprite = new Image();
			this.xIndex=xIndex;
			this.yIndex=yIndex;
			
			this.sprite.onload = function(){};
			this.sprite.src = "img/bots/r"+tipoRobot+".png";
			
			this.pintar= function(){
				ctx.drawImage(this.sprite, 10+size*xIndex,10-size*0.65+size*yIndex,size,size*1.5);
			};
			
			this.accion= "";
			this.ejecutarAccion = function(accion){
				this.accion = accion[0];
				xIndex= Math.round(xIndex);
				yIndex= Math.round(yIndex);
				if(this.accion=='N'&&yIndex<=2){
					this.accion="";
					console.log("aaa");
				}
				else if(this.accion=='S'&&yIndex>=10){
					this.accion="";
				}
				else if(this.accion=='E'&&xIndex<=2){
					this.accion="";
				}
				else if(this.accion=='O'&&xIndex>=10){
					this.accion="";
				}
				
			}
			this.mover = function(){
				switch(this.accion){
					case 'N':
						yIndex-=1/MOVF;
						if(yIndex%MOVF){
							accion="";
						}
					break;
					case 'O':
						xIndex+=1/MOVF;
						if(xIndex%MOVF){
							accion="";
						}
					break;
					case 'E':
						xIndex-=1/MOVF;
						if(xIndex%MOVF){
							accion="";
						}
					break;
					case 'S':
						yIndex+=1/MOVF;
						if(yIndex%MOVF){
							accion="";							
						}
					break;
				}
				
			};
		};
		
		window.onload= function(){
			var tablero = document.getElementById("tablero");
			var mapa = 	"XXXXXXXXXXXXX\n"+
						"XA_LL_L_LL_BX\n"+
						"X_XLX_X_XLX_X\n"+
						"XLL_______LLX\n"+
						"XLX_XLXLX_XLX\n"+
						"X___LLLLL___X\n"+
						"XLX_XLXLX_XLX\n"+
						"X___LLLLL___X\n"+
						"XLX_XLXLX_XLX\n"+
						"XLL_______LLX\n"+
						"X_XLX_X_XLX_X\n"+
						"XC_LL_L_LL_DX\n"+
						"XXXXXXXXXXXXX\n";
			if(tablero.getContext) {
				ctx = tablero.getContext('2d');
				var bloque = new Image();
				bloque.src = "img/SolidoBloque50.png";
				var ladrillo = new Image();
				ladrillo.src = "img/LadrilloBloque50.png";
				
				var bot1 = new Bot(crearRandomRobot(),7,7);
				var bot2 = new Bot(crearRandomRobot(),5,7);
				var bot3 = new Bot(crearRandomRobot(),5,5);
				var bot4 = new Bot(crearRandomRobot(),7,5);
			}
			
			var fondo = function(){
				var i=0;
				var j=0;
				var cont=0;
				ctx.beginPath();
				ctx.rect(0, 0, size*14, size*14);
				ctx.fill();
				while(cont<mapa.length){
					switch(mapa[cont]){
						case 'X':
							ctx.drawImage(bloque, 10+i*size,10+j*size,size,size);
							i++;
						break;
						case 'L':
							ctx.drawImage(ladrillo, 10+i*size,10+j*size,size,size);
							i++;
						break;
						case 'A':
						case 'B':
						case 'C':
						case 'D':
						case '_':
							i++;
						break;
						case '\n':
							j++;
							i=0;
						break;
					}
					cont++;
				}
				
				ctx.fillText("turno "+turno,50,50);
				ctx.stroke();
			};
			var xYellow=3;
			var yYellow=3;
			
			var pintar = function(){
				ctx.beginPath();				
				//ctx.drawImage(bot1, 10+size*xYellow,10-size*0.65+size*yYellow,size,size*1.5);
				bot1.pintar();
				bot2.pintar();
				bot3.pintar();
				bot4.pintar();
				
				ctx.stroke();
			};
			
			
			var factorMovbots=1/MOVF;
			
			var cont=0;
			var direccion="o";
			var moverBots= function(){
				if(direccion=="o"){
					xYellow+=factorMovbots;
					if(xYellow>=9){
						direccion="s";	
					}
				}else if(direccion=="s"){
					yYellow+=factorMovbots;
					if(yYellow>=9){
						direccion="e";	
					}
				}else if(direccion=="e"){
					xYellow-=factorMovbots;
					if(xYellow<=3){
						direccion="n";	
					}
				}else if(direccion=="n"){
					yYellow-=factorMovbots;
					if(yYellow<=3){
						direccion="o";	
					}
				}
				
				bot1.mover();
				bot2.mover();
				bot3.mover();
				bot4.mover();
				fondo();
				pintar();
				cont++;
				
			};
			
		    window.requestAnimFrame = (function(){
    			return  window.requestAnimationFrame || 
            	window.webkitRequestAnimationFrame || 
              	window.mozRequestAnimationFrame    || 
              	window.oRequestAnimationFrame      || 
              	window.msRequestAnimationFrame     || 
              	function( callback ){
                	window.setTimeout(callback, 1000 / 60);
              	};
    		})();
    		
    		var leerMapa= function(){
    			
    		};
    		
    		
    		var movs = ["N","E","S"," ","O"];
    		
    		(function animloop(){
				requestAnimFrame(animloop);
				moverBots();
				if(cont%MOVF==0){
					turno++;
					
    				leerMapa();
    				var tipoMov1 = Math.floor(Math.random()*(movs.length));
    				var tipoMov2 = Math.floor(Math.random()*(movs.length));
    				var tipoMov3 = Math.floor(Math.random()*(movs.length));
    				var tipoMov4 = Math.floor(Math.random()*(movs.length));
    				bot1.ejecutarAccion(movs[tipoMov1]);
    				bot2.ejecutarAccion(movs[tipoMov2]);
    				bot3.ejecutarAccion(movs[tipoMov3]);
    				bot4.ejecutarAccion(movs[tipoMov4]);
    				MOVF=tempVelocidad;
    				
				}
			})();
			
		};
	</script>

</head>

<body>
	
	<canvas id="tablero" width="700px" height="700px" style="background-color:#000;" style="float:left;">
		<p>what the fuck browser are you using??</p>
	</canvas>
	<div style="float:right;color:#FFF;">
		<label for ="velocidad">velocidad</label>
		<input id="velocidad" type="range"  min="2" max="48" value="20" onchange="cambiarVelocidad(50-this.value)"/>
	<div style="float:right;">

</body>



</html>
