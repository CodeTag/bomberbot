<!DOCTYPE html>

<html>
<head>
	<title>Bomberbot challenge </title>
	<style>
		body{
			background-color:#004;
		}
	</style>
	<script>
		var tipos= ['c','d','r','t'];
		var colores= ['a','b','f','m','n','r','v'];
		var ctx=undefined;
		var size=50;
		var MOVF=30;
		var turno=0;
		
		var tempVelocidad=MOVF;
		var cambiarVelocidad= function(velocidad){
			tempVelocidad = velocidad;
		}
		
		var crearRandomRobot = function(){
			var tipoSel = Math.round(Math.random()*(tipos.length-1));
			var colorSel = Math.round(Math.random()*(colores.length-1));
			return tipos[tipoSel]+""+colores[colorSel];
		};
		
		var Bot = function(nombre, tipoRobot, xIndex, yIndex){
			this.nombre = nombre;
			this.sprite = new Image();
			this.xIndex=xIndex;
			this.yIndex=yIndex;
			this.accion= "";
			this.vivo=true;
			
			this.sprite.onload = function(){};
			this.sprite.src = "img/bots/r"+tipoRobot+".png";
			
			this.pintar= function(){
				if(this.vivo){
					ctx.drawImage(this.sprite, 10+size*xIndex,10-size*0.65+size*yIndex,size,size*1.5);
				}
			};
			
			this.setX= function(i){
				xIndex = i;
			};
			this.setY= function(j){
				yIndex = j;
			};
			this.setVivo= function(vivo){
				this.vivo=vivo;
				this.accion="M";
			};
			this.isVivo= function(){
				return vivo;
			};
			this.getAccion = function(){
				switch(this.accion){
					case "N":
					return "\u2191";
					case "O":
					return "\u2192";
					case "S":
					return "\u2193";
					case "E":
					return "\u2190";
					case "P":
					return "pasa";
					case "I":
					return "Ini";
					default:
					return "M";
				}
				return "";
			};
			this.ejecutarAccion = function(accion){
				this.accion = accion[0];
				
				if(this.accion=='N'&&yIndex<=1){
					this.accion="";
				}
				else if(this.accion=='S'&&yIndex>=11){
					this.accion="";
				}
				else if(this.accion=='E'&&xIndex<=1){
					this.accion="";
				}
				else if(this.accion=='O'&&xIndex>=11){
					this.accion="";
				}
				this.vivo=true;
			};
			this.actualizarCoordenadas = function(i, j){
				xIndex= Math.round(xIndex);
				yIndex= Math.round(yIndex);
				
				if(xIndex>i){
					this.ejecutarAccion("E");
				}else if(xIndex<i){
					this.ejecutarAccion("O");
				}else if(yIndex>j){
					this.ejecutarAccion("N");
				
				}else if(yIndex<j){
					this.ejecutarAccion("S");
				}else{
					this.ejecutarAccion("P");
				}
			};
			this.mover = function(){
				if(this.vivo){
					switch(this.accion){
						case 'N':
							yIndex-=1/MOVF;
							if(yIndex%MOVF){
								accion="";
							}
						break;
						case 'O':
							xIndex+=1/MOVF;
							if(xIndex%MOVF){
								accion="";
							}
						break;
						case 'E':
							xIndex-=1/MOVF;
							if(xIndex%MOVF){
								accion="";
							}
						break;
						case 'S':
							yIndex+=1/MOVF;
							if(yIndex%MOVF){
								accion="";							
							}
						break;
						default:
						break;
					}
				}
			};
		};
		
		var mapaSource="XXXXX\nXA_BX\nX___X\nXLLLX\nX_3_X\nXC_DX\nXXXXX\n-XXXXX\nXA__X\nX__BX\nXLL_X\nX_2DX\nXC__X\nXXXXX\n-XXXXX\nX3_BX\nXA__X\nX_L_X\nX_1_X\nXC_DX\nXXXXX\n-XXXXX\nX2B_X\nX___X\nXA__X\nX___X\nXCD_X\nXXXXX\n-XXXXX\nX1B_X\nX___X\nXA__X\nX___X\nXC_DX\nXXXXX\n-XXXXX\nX__BX\nX___X\nXA__X\nX__DX\nXC__X\nXXXXX\n-XXXXX\nX__BX\nX___X\nXA__X\nX_D3X\nX_C_X\nXXXXX\n-XXXXX\nX__BX\nX___X\nXA__X\nX_D2X\nX__CX\nXXXXX\n-XXXXX\nX__BX\nX___X\nXAD_X\nX__1X\nX___X\nXXXXX\n-XXXXX\nX__BX\nX_D_X\nXA__X\nX___X\nX___X\nXXXXX\n-XXXXX\nX__BX\nXD__X\nXA__X\nX___X\nX___X\nXXXXX\n";
		window.onload= function(){
			var tablero = document.getElementById("tablero");
			var mapa = 	"";
			
			var mapaHistory =  mapaSource.split("-");
			
			if(tablero.getContext) {
				ctx = tablero.getContext('2d');
				ctx.font = '18px Calibri';
				var bloque = new Image();
				bloque.src = "img/SolidoBloque50.png";
				var ladrillo = new Image();
				ladrillo.src = "img/LadrilloBloque50.png";
				var bomba = new Image();
				bomba.src = "img/bombaAzul.png";
				
				var bot1 = new Bot("bot1",crearRandomRobot(),-1,-1);
				var bot2 = new Bot("bot2",crearRandomRobot(),-1,-1);
				var bot3 = new Bot("bot3",crearRandomRobot(),-1,-1);
				var bot4 = new Bot("bot4",crearRandomRobot(),-1,-1);
			}
			
			var fondo = function(){
				var i=0;
				var j=0;
				var cont=0;
				ctx.beginPath();
				ctx.fillStyle="#000";
				ctx.rect(0, 0, 700, 700);
				ctx.fill();
				while(cont<mapa.length){
					switch(mapa[cont]){
						case 'X':
							ctx.drawImage(bloque, 10+i*size,10+j*size,size,size);
							i++;
						break;
						case 'L':
							ctx.drawImage(ladrillo, 10+i*size,10+j*size,size,size);
							i++;
						break;
						case '3':
						case '2':
						case '1':
							ctx.drawImage(bomba, 10+i*size,10+j*size,size,size);
							i++;
						break;
						case 'A':
						case 'B':
						case 'C':
						case 'D':
						case '_':
							i++;
						break;
						case '\n':
							j++;
							i=0;
						break;
					}
					cont++;
				}
				
				ctx.stroke();
			};
			var pintarStatus = function(){
				ctx.beginPath();
				ctx.fillStyle="#000";
				ctx.rect(700, 0, 150, 700);
				ctx.fill();
				ctx.fillStyle="#FFF";
				ctx.fillText("Turno "+turno,750,50);
				
				
				ctx.drawImage(bot1.sprite,750,70,20,30);
				ctx.fillText(bot1.nombre,710,85);
				ctx.fillText(bot1.getAccion(),800,85);
				
				ctx.drawImage(bot2.sprite,750,120,20,30);
				ctx.fillText(bot2.nombre,710,135);
				ctx.fillText(bot2.getAccion(),800,135);
				
				ctx.drawImage(bot3.sprite,750,170,20,30);
				ctx.fillText(bot3.nombre,710,185);
				ctx.fillText(bot3.getAccion(),800,185);
				
				ctx.drawImage(bot4.sprite,750,220,20,30);
				ctx.fillText(bot4.nombre,710,220);
				ctx.fillText(bot4.getAccion(),800,235); 
				ctx.stroke();
			}
			
			var pintar = function(){
				ctx.beginPath();
				bot1.pintar();
				bot2.pintar();
				bot3.pintar();
				bot4.pintar();
				
				ctx.stroke();
			};
			
			
			var factorMovbots=1/MOVF;
			
			var cont=0;
			var direccion="o";
			var moverBots= function(){
				
				bot1.mover();
				bot2.mover();
				bot3.mover();
				bot4.mover();
				fondo();
				pintar();
				cont++;
				
			};
			
		    window.requestAnimFrame = (function(){
    			return  window.requestAnimationFrame || 
            	window.webkitRequestAnimationFrame || 
              	window.mozRequestAnimationFrame    || 
              	window.oRequestAnimationFrame      || 
              	window.msRequestAnimationFrame     || 
              	function( callback ){
                	window.setTimeout(callback, 1000 / 60);
              	};
    		})();
    		
    		var leerMapa= function(){
    			var i=0;
				var j=0;
				var cont=0;
				mapa= mapaHistory[turno];
    			if(turno==0){
    				while(cont<mapa.length){
						switch(mapa[cont]){
							case '\n':
								j++;
								i=0;
							break;
							case 'A':
								bot1.setX(i);
								bot1.setY(j);
								i++;
							break;
							case 'B':
								bot2.setX(i);
								bot2.setY(j);
								i++;
							break;
							case 'C':
								bot3.setX(i);
								bot3.setY(j);
								i++;
							break;
							case 'D':
								bot4.setX(i);
								bot4.setY(j);
								i++;
							break;
							default:
								i++;
								break;
						}
						cont++;
					}
					bot1.ejecutarAccion("I");
					bot2.ejecutarAccion("I");
					bot3.ejecutarAccion("I");
					bot4.ejecutarAccion("I");
					
    			}else{
    				bot1.setVivo(false);
					bot2.setVivo(false);
					bot3.setVivo(false);
					bot4.setVivo(false);
    			}
    			
				while(cont<mapa.length){
					switch(mapa[cont]){
						
						case '\n':
							j++;
							i=0;
						break;
						case 'A':
							bot1.actualizarCoordenadas(i,j);
							i++;
						break;
						case 'B':
							bot2.actualizarCoordenadas(i,j);
							i++;
							break;
						case 'C':
							bot3.actualizarCoordenadas(i,j);
							i++;
							break;
						case 'D':
							bot4.actualizarCoordenadas(i,j);
							i++;
							break;
						default:
							i++;
						break;
					}
					cont++;
				}
    			
			};
    			
    		var movs = ["N","E","S","P","O"];
    		var fin=false;
    		(function animloop(){
				if(!fin){
					requestAnimFrame(animloop);
				}
				if(cont%MOVF==0){
					if(turno==mapaHistory.length){
						fin=true;
					}else{
						leerMapa();
						MOVF=tempVelocidad;
						pintarStatus();
						turno++;
					}
				}
				moverBots();	
				
			})();
			
		};
	</script>

</head>

<body>
	
	<canvas id="tablero" width="850px" height="700px" style="background-color:#000;" style="float:left;">
		<p>what the fuck browser are you using??</p>
	</canvas>
	<div style="float:right;color:#FFF;">
		<label for ="velocidad">velocidad</label>
		<input id="velocidad" type="range"  min="2" max="48" value="20" onchange="cambiarVelocidad(50-this.value)"/>
	<div style="float:right;">

</body>



</html>
